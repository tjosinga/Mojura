<input type="hidden" name="setting_fileids" value="{{fileids}}" />

<div class="current_images"></div>
<a href="javascript:void(0)" class="btn image_add_button" onclick="ImageEditView.addImage();">
	<i class="icon-plus"></i>
</a>
<div class="select_file_container clearfix"></div>

<label class="checkbox slideshow-checkbox">
	<input type="checkbox" name="setting_slideshow" value="true" {{#slideshow}}checked="checked"{{/slideshow}} />
	{{locale_str_images_slideshow}}
</label>

<style type="text/css">

	#modalEditView .image-thumb	{
		margin: 0 5px 5px 0;
		background-color: #EEEEEE;
	}

	#modalEditView .image-thumb img	{
		width: 64px;
		height: 64px;
	}

	#modalEditView .image_add_button {
		display: inline-block;
		margin: 17px 12px;
	}
</style>


<script type="text/javascript">
    //noinspection LocalVariableNamingConventionJS
    var ImageEditView;
    ImageEditView = (function($) {

		function setFileIdsToForm() {
			fileids = [];
			$(".image-thumb", "#modalEditView").each(function(index) {
				fileids.push($(this).attr("data-fileid"));
			});
			$("[name=setting_fileids]", "#modalEditView").val(fileids.join(","));
			if (fileids.length > 1)
				$(".slideshow-checkbox", "#modalEditView").show();
			else
				$(".slideshow-checkbox", "#modalEditView").hide();

		}

		function getFileIdsFromForm() {
			ids_str = $("[name=setting_fileids]", "#modalEditView").val();
			if (ids_str == "")
				return [];
			else
				return ids_str.split(",");
		};

		function fileIdToHTML(fileid) {
			return "<div class='pull-left image-thumb' onclick='ImageEditView.removeImage(this)' data-fileid='" + fileid + "'><img src='__api__/files/" + fileid + "/download?type=avatar' alt='' /></div>"
		};

		function showImages() {
			ids = getFileIdsFromForm();
			html = "";
			for (i in ids) {
				html += fileIdToHTML(ids[i]);
			}
			$(".current_images", "#modalEditView").html(html);
		};

		function addImage() {
			Locale.ensureLoaded('files', {loaded: function () {
				url = "views/files/coworkers/select_file.mustache?static_only=true";
				$.get(url, {cache: false}, function (template) {
					html = Mustache.to_html(template, Locale.rawStrings(["system", "files"]));
					$("#modalEditView .select_file_container").html(html);
					SelectFile.show({multi: true, parentModalId: "modalEditView", filter: [".png", ".jpeg", ".jpg", "gif"],
						confirmed: function (ids) {
							for (i in ids) {
								if ($("#modalEditView .current_images div[data-fileid=" + ids[i] + "]").length === 0)
									$(".current_images", "#modalEditView").append(fileIdToHTML(ids[i]));
							}
							setFileIdsToForm();
						},
						hidden: function () {
						}
					});
				});
			}});
		};

		function removeImage(obj) {
			$(obj).remove();
			setFileIdsToForm();
		};

		showImages();

		return {
			showImages: showImages,
			addImage: addImage,
			removeImage: removeImage
		};

	})(jQuery);

</script>

