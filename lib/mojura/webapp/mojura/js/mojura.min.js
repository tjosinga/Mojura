var AdvancedObjectRights=(function(c){var k;function j(p,q,n,m){var o=m.parentModalId;Modal.create({title:Locale.str("system","advanced_object_rights"),oncreated:function(s,r){k=s;h(p,q,n);if(typeof o!=="undefined"){c("#"+o).removeClass("fade").one("hidden.bs.modal",function(){c("#"+k).removeClass("fade").one("hidden.bs.modal",function(){c("#"+o).one("shown.bs.modal",function(){c(this).addClass("fade")}).modal("show")}).modal("show")}).modal("hide")}else{r()}},onaction:function(){if(typeof m.onsave!=="undefined"){m.onsave(i(),g("users"),g("groups"))}c("#"+k).modal("hide")}})}function h(q,s,m){var o=c("#template-advanced-object-rights").html();var p=Locale.getViewStrings("system");p.categories=[{name:Locale.str("system","guests"),bits:[4,3,2,1]},{name:Locale.str("system","users"),bits:[8,7,6,5]},{name:Locale.str("system","groupmembers"),bits:[12,11,10,9]},{name:Locale.str("system","owners"),bits:[16,15,14,13]}];var n=Mustache.render(o,p);c(".modal-body","#"+k).html(n);l(q);b("users",s);b("groups",m);var r=function(t){c(t).closest(".input-group").find(".btn-success").toggleClass("disabled",c(t).attr("data-id")==="")};AutoComplete.prepare("#"+k+" .add-users input",{category:"users",onselected:r});AutoComplete.prepare("#"+k+" .add-groups input",{category:"groups",onselected:r})}function l(m){c(".advanced-rights-checkbox","#"+k).each(function(){var p=parseInt(c(this).attr("data-bit"),10);var o=1<<(p-1);var n=(m&o);c(this).prop("checked",(m&o))})}function i(){var m=0;c(".advanced-rights-checkbox:checked","#"+k).each(function(){var n=parseInt(c(this).attr("data-bit"),10);m+=1<<(n-1)});return m}function b(o,n){if(n.length>0){c(".advanced-rights-"+o+"-list","#"+k).html("<div class='loading'></div>");var m="__api__/"+o+"?filter=id:("+n.join(encodeURIComponent("|"))+")";c.getJSON(m,function(q){var r=c("#template-advanced-object-rights-"+o).html();var s={};s[o]=q.items;var p=Mustache.render(r,s);c(".advanced-rights-"+o+"-list","#"+k).html(p);c(".advanced-rights-"+o+"-alert","#"+k).toggleClass("hidden",q.items.length!==0)})}else{c(".advanced-rights-"+o+"-alert","#"+k).removeClass("hidden")}}function g(n){var m=[];c(".advanced-rights-"+n+"-list .listitem","#"+k).each(function(){m.push(c(this).attr("data-id"))});return m}function e(m,o){c(m).parent().parent().remove();var n=(c(".advanced-rights-"+o+"-list .listitem","#"+k).size()>0);c(".advanced-rights-"+o+"-alert","#"+k).toggleClass("hidden",n)}function d(m){c("#"+k+" .add-"+m).removeClass("hidden").find(".btn-success").addClass("disabled")}function a(o){var s=c(".add-"+o+" input","#"+k);var r=s.attr("data-id");var q=s.val();var p={};if(o==="users"){p={users:{id:r,fullname:q}}}else{p={groups:{id:r,name:q}}}var n=c("#template-advanced-object-rights-"+o).html();var m=Mustache.render(n,p);c(".advanced-rights-"+o+"-list","#"+k).append(m);c(".advanced-rights-"+o+"-alert").addClass("hidden");c("#"+k+" .add-"+o).addClass("hidden")}function f(m){c("#"+k+" .add-"+m).addClass("hidden")}return{show:j,removeId:e,showAdd:d,confirmAdd:a,cancelAdd:f}})(jQuery);var Alert=(function(){var b;function a(c){c.type=(typeof c.type!=="undefined")?c.type:"danger";c.dismissable=(typeof c.dismissable!=="undefined")?c.dismissable:true;if(typeof c.title==="undefined"){c.title=Locale.str("system","alert_title_"+c.type)}if(typeof b==="undefined"){b=$("#template-alert").html()}return Mustache.render(b,c)}return{create:a}})();var AutoComplete=(function(d){var c={};function b(g,h){var j=h.dataset||h.category||UIDGenerator.get();c[j]={input:g,options:a(h)};var k=d(g);d(g).after("<ul class='autocomplete-dropdown dropdown-menu hidden' data-toggle='dropdown'></ul>");c[j].$input=k;c[j].options=a(h);c[j].$dropdown=k.next(".autocomplete-dropdown");h=c[j].options;var i=c[j].$dropdown;var f="";k.blur(function(){clearTimeout(h.timer);var l=c[j].$dropdown.children("li");if((l.size()===1)&&(l.first().text()===d(this).val())){l.first().click();return}setTimeout(function(){if((typeof k.attr("data-id")==="undefined")||(k.attr("data-id")==="")){k.val("")}i.addClass("hidden")},500)}).keyup(function(m){if(m.keyCode===27){i.addClass("hidden")}else{if(m.keyCode===38){i.children("li.active").prev("li").addClass("active").next("li").removeClass("active")}else{if(m.keyCode===40){var l=i.children("li.active");if(l.size()===0){i.children("li").first().addClass("active")}else{l.next().addClass("active").prev().removeClass("active")}}else{if(m.keyCode===13){i.children("li.active").click()}}}}}).keypress(function(){if((h.timer===null)||(typeof h.timer==="undefined")){clearTimeout(h.timer)}h.timer=setTimeout(function(){e(j,k.val())},h.delay)})}function a(f){f=f||{};f.url=f.url||"__api__/search?keywords=%KEYWORDS%&pagesize=%LENGTH%&category=%CATEGORY%";f.item_template=f.item_template||"<li data-id='{{id}}'>{{title}}</li>";f.timer=null;f.length=f.length||8;f.category=f.category||"";f.forceSelection=true;f.delay=1000;return f}function e(j,h){var i=c[j].$dropdown;var k=c[j].$input;var g=c[j].options;if(h===""){i.addClass("hidden");return}var f=g.url.replace(/%KEYWORDS%/,h).replace(/%LENGTH%/,g.length).replace(/%CATEGORY%/,g.category);d.getJSON(f,function(o){var l="";var n="";for(var m in o){n+=Mustache.render(g.item_template,o[m])}i.toggleClass("hidden",(n===""));i.html(n).children("li").click(function(){clearTimeout(g.timer);k.attr("data-id",d(this).attr("data-id")).val(d(this).text());i.addClass("hidden");if(typeof g.onselected!=="undefined"){g.onselected(k[0])}})})}return{prepare:b}})(jQuery);var KeyValueParser=(function(){var a;function c(f,j){j=(typeof j!=="undefined")?j:{};j.sep_char=(typeof j.sep_char!=="undefined")?j.sep_char:"=";j.trim_values=(typeof j.trim_values!=="undefined")?j.trim_values:true;j.comment_char=(typeof j.comment_char!=="undefined")?j.comment_char:"#";var m={};var k=f.match(/[^\r\n]+/g);for(var d in k){if(k.hasOwnProperty(d)){var l=k[d].replace(/^\s+|\s+$/g);if((l!=="")&&(l[0]!==j.comment_char)){var e=l.split(j.sep_char,2);var h=e[0].toString().replace(/^\s+|\s+$/g,"");var g=e[1];if(j.trim_values){g=g.replace(/^\s+|\s+$/g,"")}m[h]=g}}}a=m;return m}function b(){var d="";if(typeof a!=="undefined"){for(var e in a){if(a.hasOwnProperty(e)){d+=e+": "+a[e]+"\n"}}}return d}return{parse:c,toString:b}})();var LightBox=(function(f){var e={};var j={};var o;var a;var d;var b;var n;function p(u,r,q){e[u]=e[u]||[];j[u]=j[u]||0;q=q||{};q.url=r;if(r.match(/(http:|https:)?\/\/(www\.)?(youtube.com|youtu.be)\/(watch)?(\?v=)?(\S+)?/)){q.type="iframe";q.url=q.url.replace("watch?v=","v/")}else{if(r.match(/vimeo/)){var t=q.url.match(/(https?:\/\/)?(www.)?(player.)?vimeo.com\/([a-z]*\/)*([0-9]{6,11})[?]?.*/);var s=t.pop();q.type="iframe";q.url="https://player.vimeo.com/video/"+s}else{if(typeof q.type==="undefined"){q.type="image"}}}q.name="";q.description="";e[u].push(q)}function l(t,r){if(typeof e[t]==="undefined"){return}o=t;n=n||f("#template-lightbox").html();if(typeof r==="number"){j[o]=r}else{j[o]=k(r)}var s=Mustache.to_html(n,{group:o});f("body").append(s);a=f("#lightbox-"+o);b=f(".lightbox-content",a);d=f(".lightbox-dialog",a);var q=function(u){if(u.keyCode===27){a.modal("hide")}else{if(u.keyCode===37){i()}else{if(u.keyCode===39){h()}}}};a.on("shown.bs.modal",function(){f(document).on("keyup",q)});a.on("hide.bs.modal",function(){f(document).off("keyup",q)});a.on("hidden.bs.modal",function(){a.remove()});f(".lightbox-left, .lightbox-right",a).toggleClass("hidden",e[o].length<2);m();a.modal("show")}function m(){var s=j[o]||0;var u=e[o][s];var q=f(".aspect-ratio",a);f(".lightbox-content > *, .lightbox-content .aspect-ratio > *",a).addClass("hidden");if(u.type==="image"){var t=f(".lightbox-image",a);if(t.src!==u.url){t.attr("src",u.url)}t.removeClass("hidden");q.addClass("hidden")}else{if(u.type==="video"){var r=f(".lightbox-video",a);f("source",r).attr("src",u.url);r.removeClass("hidden")}else{if(u.type==="iframe"){var v=f(".lightbox-iframe",a);if(v.attr("src")!==u.url){v.attr("src",u.url).load(function(){f(this).removeClass("hidden")})}else{v.removeClass("hidden")}}}q.removeClass("hidden")}}function c(q){var r=e[o].length;j[o]=(j[o]+r+q)%r;m(o)}function i(){c(-1)}function h(){c(1)}function k(q){for(var r in e[o]){if(typeof e[o][r]!=="undefined"){var s=e[o][r];if(s.url===q){return Number(r)}}}return 0}function g(q){e[q]=[];j[q]=0}return{add:p,show:l,previous:i,next:h,clear:g}})(jQuery);var LightBox=(function(A){var B={};var w={};var r;var F;var C;var E;var s;function q(a,d,e){B[a]=B[a]||[];w[a]=w[a]||0;e=e||{};e.url=d;if(d.match(/(http:|https:)?\/\/(www\.)?(youtube.com|youtu.be)\/(watch)?(\?v=)?(\S+)?/)){e.type="iframe";e.url=e.url.replace("watch?v=","v/")}else{if(d.match(/vimeo/)){var b=e.url.match(/(https?:\/\/)?(www.)?(player.)?vimeo.com\/([a-z]*\/)*([0-9]{6,11})[?]?.*/);var c=b.pop();e.type="iframe";e.url="https://player.vimeo.com/video/"+c}else{if(typeof e.type==="undefined"){e.type="image"}}}e.name="";e.description="";B[a].push(e)}function u(a,c){if(typeof B[a]==="undefined"){return}r=a;s=s||A("#template-lightbox").html();if(typeof c==="number"){w[r]=c}else{w[r]=v(c)}var b=Mustache.to_html(s,{group:r});A("body").append(b);F=A("#lightbox-"+r);E=A(".lightbox-content",F);C=A(".lightbox-dialog",F);var d=function(e){if(e.keyCode===27){F.modal("hide")}else{if(e.keyCode===37){x()}else{if(e.keyCode===39){y()}}}};F.on("shown.bs.modal",function(){A(document).on("keyup",d)});F.on("hide.bs.modal",function(){A(document).off("keyup",d)});F.on("hidden.bs.modal",function(){F.remove()});A(".lightbox-left, .lightbox-right",F).toggleClass("hidden",B[r].length<2);t();F.modal("show")}function t(){var d=w[r]||0;var b=B[r][d];var f=A(".aspect-ratio",F);A(".lightbox-content > *, .lightbox-content .aspect-ratio > *",F).addClass("hidden");if(b.type==="image"){var c=A(".lightbox-image",F);if(c.src!==b.url){c.attr("src",b.url)}c.removeClass("hidden");f.addClass("hidden")}else{if(b.type==="video"){var e=A(".lightbox-video",F);A("source",e).attr("src",b.url);e.removeClass("hidden")}else{if(b.type==="iframe"){var a=A(".lightbox-iframe",F);if(a.attr("src")!==b.url){a.attr("src",b.url).load(function(){A(this).removeClass("hidden")})}else{a.removeClass("hidden")}}}f.removeClass("hidden")}}function D(b){var a=B[r].length;w[r]=(w[r]+a+b)%a;t(r)}function x(){D(-1)}function y(){D(1)}function v(c){for(var b in B[r]){if(typeof B[r][b]!=="undefined"){var a=B[r][b];if(a.url===c){return Number(b)}}}return 0}function z(a){B[a]=[];w[a]=0}return{add:q,show:u,previous:x,next:y,clear:z}})(jQuery);var Locale=(function(b){var f="";var h={};function j(l){f=l}function c(l,m){if(typeof h[l]==="undefined"){g(l,m)}else{if((typeof m!=="undefined")&&(typeof m.loaded!=="undefined")){m.loaded()}}}function g(l,n){if(f===""){window.alert('You should initialize the locale object with Locale.init("en"), where "en" is the used locale.');return}if(typeof l==="undefined"){throw"The view needs to be set calling Locale.load(view, [options = {}])"}var m=(l==="system")?"mojura/views/strings."+f+".kv":"views/"+l+"/strings."+f+".kv";b.ajax({url:m,error:function(){if((typeof n!=="undefined")&&(typeof n.loaded!=="undefined")&&(n.breakOnFail!==true)){n.loaded()}},fail:function(){window.console.log("Error fetching "+m);if(typeof n.error!=="undefined"){n.error()}if((typeof n!=="undefined")&&(typeof n.loaded!=="undefined")&&(n.breakOnFail!==true)){n.loaded()}},success:function(p){try{h[l]=KeyValueParser.parse(p);if((typeof n!=="undefined")&&(typeof n.loaded!=="undefined")){n.loaded()}}catch(o){window.console.log("Error on parsing "+m+": "+o.message);h[l]={};if(typeof n.error!=="undefined"){n.error()}}}})}function k(l,n,m){if(typeof h[l]==="undefined"){h[l]={}}h[l][n]=m}function e(l,m){if((typeof h[l]!=="undefined")&&(typeof h[l][m]!=="undefined")){return h[l][m]}else{return"__"+l+"_"+m+"__"}}function d(){var l=[];b.each(h,function(m,n){l.push(m)});return l}function i(m,n,p){n=(typeof n==="undefined")||(n===true);var o=(typeof p!=="undefined");var l={};if(typeof h[m]!=="undefined"){b.each(h[m],function(r,q){if((!o)||(r.indexOf(p)===0)){if(n){l["locale_str_"+m+"_"+r]=q}else{l[r]=q}}})}return l}function a(m,n,o){n=(typeof n==="undefined")||(n===true);var l={};if(typeof m==="undefined"){return l}b.each(m,function(q,p){var r=i(p,n,o);if(n){l=b.extend({},l,r)}else{l[p]=r}});return l}return{init:j,ensureLoaded:c,loadedViews:d,add:k,str:e,getViewStrings:i,getViewsStrings:a}})(jQuery);var Modal=(function(c){var a=1;var g;var h;var i;var f;function d(j){h=j;Locale.ensureLoaded("system",{loaded:function(){var l=c("#template-modal").html();if(typeof h.id==="undefined"){h.id="modal_"+a++}h.btn_action=(typeof h.btn_action!=="undefined")?h.btn_action:Locale.str("system","save");h.btn_class=(typeof h.btn_class!=="undefined")?h.btn_class:"btn-primary";h.btn_cancel=(typeof h.btn_cancel!=="undefined")?h.btn_cancel:Locale.str("system","cancel");h.modal_large=(h.modal_large===true);h.fade=(h.fade!==false);h.urid=UIDGenerator.get();h.save_form=(h.save_form!==false);var k=Mustache.render(l,h);c("body").append(k);g=c("#"+h.id);g.on("hidden.bs.modal",function(m){if(g.hasClass("fade")){g.remove()}});if((!h.oncreated)||(!h.oncreated(h.id,b))){b()}}})}function b(){f=c("."+h.btn_class,g);i=c("form",g);var j=(h.save_form)&&(i.size()>0);if(j){i.on("submit",e)}f.click(function(){if(j){e()}else{if(typeof h.onaction!=="undefined"){f.button("loading");try{h.onaction(h.id)}catch(k){}}else{c("#"+h.id).modal("hide")}}});g.modal("show")}function e(){i=c("form",g);if(!Validator.validateForm(i[0])){return false}f.button("loading");i.ajaxSubmit({success:function(j){f.button("complete").addClass("btn-success disabled");setTimeout(function(){if(typeof h.onsubmitted!=="undefined"){h.onsubmitted(h.id,j)}c("#"+h.id).modal("hide")},200)},error:function(j){f.button("reset");if(typeof h.onerror!=="undefined"){h.onerror(h.id,j.status)}}});return false}return{create:d}})(jQuery);var PageEditor=(function(g){var d="";var n=[];function o(s,t){d=s;n=t;var r="";g(".page-content-parts").sortable({handle:".editable .sortable-handle",itemSelector:".editable",vertical:true,nested:true,placeholder:"<i class='fa fa-chain text-danger'></i>",containerSelector:".page-content-parts, .view-subviews",onDragStart:function(v,u,w){r=i(v[0])},onDrag:function(v,u,w){v.css(u);w(v,u)},onDrop:function(v,u,x){x(v,u);var w=i(v[0]);if(w!==r){window.alert("moved")}}})}function b(){g(".btn-edit-page").toggleClass("hidden");g(".view-admin").toggleClass("hidden").parent().toggleClass("editable");var r=window.location.toString().replace(/#+editing/,"");if(g(".btn-edit-page").is(":visible")){r+="#editing"}history.pushState({},document.title,r)}function a(){m("post",d)}function p(){m("post","")}function j(){m("put")}function m(t,s){var r=(t==="post")?"add_page":"edit_page";Modal.create({title:Locale.str("system",r),oncreated:function(u,w){var v="__api__/pages/";v+=(t==="put")?d:"new";g("#"+u).modal("show");g.getJSON(v,function(A){var z=g("#template-pageview-addedit-page").html();A=g.extend({},A,Locale.getViewsStrings(["system"]));if(typeof s!=="undefined"){A.parentid=s}A.method=t;A.urid=UIDGenerator.get();A.simple_rights_visible=((A.rights.rights&4)>0);var y={"rights-controls":g("#template-rights-controls").html()};var x=Mustache.render(z,A,y);g(".modal-body","#"+u).html(x);w()});return true},onsubmitted:function(u,x){var v="";if(typeof x.breadcrumbs!=="undefined"){for(var w=0;w<x.breadcrumbs.length;w++){v+=encodeURI(x.breadcrumbs[w].title)+"/"}}v+=encodeURI(x.title)+"#editing";document.location=v.replace(/%20/g,"+")}})}function l(){Modal.create({title:Locale.str("system","delete_page"),btn_action:Locale.str("system","delete"),btn_class:"btn-danger",oncreated:function(r){var t=g("#template-pageview-delete-page").html();var u=Locale.getViewsStrings(["system"]);u.pageid=d;u.urid=UIDGenerator.get();var s=Mustache.render(t,u);g(".modal-body","#"+r).html(s);g("#"+r).modal("show")},onsubmitted:function(r,t){var s=document.location.toString();document.location=s.slice(0,s.lastIndexOf("/"))}})}function i(s){var r="";g(s).parents(".view").each(function(t,u){r=g(u).index().toString()+","+r});return r+g(s).index()}function k(s){var u="";var t={};var r="";Modal.create({title:Locale.str("system","edit_view"),modal_large:true,oncreated:function(v,x){r=i(s);var w="__api__/pages/"+d+"/view/"+r;g("#"+v).modal("show");g.getJSON(w,function(B){u=B.view;t=g.extend({},B.settings);var A=g("#template-pageview-edit-view").html();B=g.extend({},B,Locale.getViewsStrings(["system"]));B.urid=UIDGenerator.get();B.pageid=d;B.views=n;B.available_col_spans=[];for(var z=1;z<=12;z++){B.available_col_spans.push(z)}B.available_col_offsets=[];for(z=0;z<=12;z++){B.available_col_offsets.push(z)}var y=Mustache.render(A,B);g(".modal-body","#"+v).html(y);e("#"+v,B);x()});return true},onsubmitted:function(v,w){if((u!==w.view)||(JSON.stringify(t)!==JSON.stringify(w.settings))){location.reload()}else{g(s).children(".view-text").html(w.content.html)}}})}function e(s,u){g("select[name=view]",s).change(function(){var v=g(this).val();if(v===""){g(".view-settings",s).html("");g(".view_texteditor textarea",s).removeClass("small");return}g(".view_texteditor textarea",s).addClass("small");g(".view-settings",s).html("<div class='loading'></div>");Locale.ensureLoaded(v,{loaded:function(){var w="views/"+v+"/coworkers/view_edit_settings.mustache?static_only=true";g.get(w,{cache:false},function(y){var z=Locale.getViewsStrings(["system",v]);u.urid=UIDGenerator.get();u.pageid=d;if(typeof u.settings==="undefined"){u.settings={}}u.settings.modalId=s.replace(/^#/,"");for(var A in z){if(z.hasOwnProperty(A)){u.settings[A]=z[A]}}var x=Mustache.to_html(y,u.settings);g(".view-settings",s).html(x)}).error(function(){g(".view-settings",s).html("")})}})}).val(u.view).trigger("change");g("select[name=col_span]",s).val(u.col_span);g("select[name=col_offset]",s).val(u.col_offset);g("select[name=row_offset]",s).val(u.row_offset);g("select[name=view] option",s).removeAttr("disabled");if(u.col_span<12){var r=[];for(var t=12;t>u.col_span;t--){r.push(".min-col-span"+t)}g(r.join(",")).attr("disabled","disabled")}TextEditor.init("#content_"+u.urid,s)}function q(r){Modal.create({title:Locale.str("system","delete_view"),btn_action:Locale.str("system","delete"),btn_class:"btn-danger",oncreated:function(s){var u=g("#template-pageview-delete-view").html();var v=Locale.getViewsStrings(["system"]);v.pageid=d;v.viewid=i(r);v.urid=UIDGenerator.get();var t=Mustache.render(u,v);g(".modal-body","#"+s).html(t)},onsubmitted:function(s,t){g(r).remove()}})}function h(s){if(typeof s.children!=="undefined"){s.has_children=(s.children.length>0);for(var r in s.children){h(s.children[r])}}else{s.children=false}s.is_base=false}function c(){Modal.create({title:Locale.str("system","sitemap_view"),btn_action:Locale.str("system","close"),btn_cancel:false,modal_large:true,save_form:false,oncreated:function(r,t){var s="__api__/pages/?use_locale=false";g("#"+r).modal("show");g.getJSON(s,function(v){var w=g("#template-sitemap-view").html();var x=Locale.getViewsStrings(["system"]);x.children=v;x.pageid=d;x.urid=UIDGenerator.get();h(x);x.is_base=true;var u=Mustache.render(w,x,{sitemap:w});g(".modal-body","#"+r).html(u);SitemapView.register("sitemap-"+x.urid).initialize("sitemap-"+x.urid,d);t()});return true},onaction:function(r){var s="__api__/pages?user_locale=false&path_pageid="+d;g.getJSON(s,function(u){var v="";for(var t in u){v+=encodeURIComponent(u[t].title)+"/"}document.location=v.slice(0,-1).replace(/%20/g,"+")+"#editing"});g("#"+r).modal("hide")}})}function f(r,t){var s="__api__/pages/"+d+"/views/?_method=post&template="+r;if((t!==undefined)&&(t!=="")){s+="&parentid="+t}g.getJSON(s,function(u){location.reload()})}return{init:o,togglePageAdmins:b,showAddSubpage:a,showAddMainpage:p,showEditPage:j,showDeletePage:l,showEditView:k,showDeleteView:q,addSubview:f,showSitemap:c}})(jQuery);var PageEditor=(function(B){var E="";var u=[];function t(b,a){E=b;u=a;var c="";B(".page-content-parts").sortable({handle:".editable .sortable-handle",itemSelector:".editable",vertical:true,nested:true,placeholder:"<i class='fa fa-chain text-danger'></i>",containerSelector:".page-content-parts, .view-subviews",onDragStart:function(e,f,d){c=z(e[0])},onDrag:function(e,f,d){e.css(f);d(e,f)},onDrop:function(f,g,d){d(f,g);var e=z(f[0]);if(e!==c){window.alert("moved")}}})}function G(){B(".btn-edit-page").toggleClass("hidden");B(".view-admin").toggleClass("hidden").parent().toggleClass("editable");var a=window.location.toString().replace(/#+editing/,"");if(B(".btn-edit-page").is(":visible")){a+="#editing"}history.pushState({},document.title,a)}function H(){v("post",E)}function s(){v("post","")}function y(){v("put")}function v(a,b){var c=(a==="post")?"add_page":"edit_page";Modal.create({title:Locale.str("system",c),oncreated:function(f,d){var e="__api__/pages/";e+=(a==="put")?E:"new";B("#"+f).modal("show");B.getJSON(e,function(h){var i=B("#template-pageview-addedit-page").html();h=B.extend({},h,Locale.getViewsStrings(["system"]));if(typeof b!=="undefined"){h.parentid=b}h.method=a;h.urid=UIDGenerator.get();h.simple_rights_visible=((h.rights.rights&4)>0);var j={"rights-controls":B("#template-rights-controls").html()};var g=Mustache.render(i,h,j);B(".modal-body","#"+f).html(g);d()});return true},onsubmitted:function(g,d){var f="";if(typeof d.breadcrumbs!=="undefined"){for(var e=0;e<d.breadcrumbs.length;e++){f+=encodeURI(d.breadcrumbs[e].title)+"/"}}f+=encodeURI(d.title)+"#editing";document.location=f.replace(/%20/g,"+")}})}function w(){Modal.create({title:Locale.str("system","delete_page"),btn_action:Locale.str("system","delete"),btn_class:"btn-danger",oncreated:function(d){var b=B("#template-pageview-delete-page").html();var a=Locale.getViewsStrings(["system"]);a.pageid=E;a.urid=UIDGenerator.get();var c=Mustache.render(b,a);B(".modal-body","#"+d).html(c);B("#"+d).modal("show")},onsubmitted:function(c,a){var b=document.location.toString();document.location=b.slice(0,b.lastIndexOf("/"))}})}function z(a){var b="";B(a).parents(".view").each(function(d,c){b=B(c).index().toString()+","+b});return b+B(a).index()}function x(c){var a="";var b={};var d="";Modal.create({title:Locale.str("system","edit_view"),modal_large:true,oncreated:function(g,e){d=z(c);var f="__api__/pages/"+E+"/view/"+d;B("#"+g).modal("show");B.getJSON(f,function(k){a=k.view;b=B.extend({},k.settings);var h=B("#template-pageview-edit-view").html();k=B.extend({},k,Locale.getViewsStrings(["system"]));k.urid=UIDGenerator.get();k.pageid=E;k.views=u;k.available_col_spans=[];for(var i=1;i<=12;i++){k.available_col_spans.push(i)}k.available_col_offsets=[];for(i=0;i<=12;i++){k.available_col_offsets.push(i)}var j=Mustache.render(h,k);B(".modal-body","#"+g).html(j);D("#"+g,k);e()});return true},onsubmitted:function(f,e){if((a!==e.view)||(JSON.stringify(b)!==JSON.stringify(e.settings))){location.reload()}else{B(c).children(".view-text").html(e.content.html)}}})}function D(c,a){B("select[name=view]",c).change(function(){var e=B(this).val();if(e===""){B(".view-settings",c).html("");B(".view_texteditor textarea",c).removeClass("small");return}B(".view_texteditor textarea",c).addClass("small");B(".view-settings",c).html("<div class='loading'></div>");Locale.ensureLoaded(e,{loaded:function(){var f="views/"+e+"/coworkers/view_edit_settings.mustache?static_only=true";B.get(f,{cache:false},function(j){var i=Locale.getViewsStrings(["system",e]);a.urid=UIDGenerator.get();a.pageid=E;if(typeof a.settings==="undefined"){a.settings={}}a.settings.modalId=c.replace(/^#/,"");for(var h in i){if(i.hasOwnProperty(h)){a.settings[h]=i[h]}}var g=Mustache.to_html(j,a.settings);B(".view-settings",c).html(g)}).error(function(){B(".view-settings",c).html("")})}})}).val(a.view).trigger("change");B("select[name=col_span]",c).val(a.col_span);B("select[name=col_offset]",c).val(a.col_offset);B("select[name=row_offset]",c).val(a.row_offset);B("select[name=view] option",c).removeAttr("disabled");if(a.col_span<12){var d=[];for(var b=12;b>a.col_span;b--){d.push(".min-col-span"+b)}B(d.join(",")).attr("disabled","disabled")}TextEditor.init("#content_"+a.urid,c)}function r(a){Modal.create({title:Locale.str("system","delete_view"),btn_action:Locale.str("system","delete"),btn_class:"btn-danger",oncreated:function(e){var c=B("#template-pageview-delete-view").html();var b=Locale.getViewsStrings(["system"]);b.pageid=E;b.viewid=z(a);b.urid=UIDGenerator.get();var d=Mustache.render(c,b);B(".modal-body","#"+e).html(d)},onsubmitted:function(c,b){B(a).remove()}})}function A(a){if(typeof a.children!=="undefined"){a.has_children=(a.children.length>0);for(var b in a.children){A(a.children[b])}}else{a.children=false}a.is_base=false}function F(){Modal.create({title:Locale.str("system","sitemap_view"),btn_action:Locale.str("system","close"),btn_cancel:false,modal_large:true,save_form:false,oncreated:function(c,a){var b="__api__/pages/?use_locale=false";B("#"+c).modal("show");B.getJSON(b,function(f){var e=B("#template-sitemap-view").html();var d=Locale.getViewsStrings(["system"]);d.children=f;d.pageid=E;d.urid=UIDGenerator.get();A(d);d.is_base=true;var g=Mustache.render(e,d,{sitemap:e});B(".modal-body","#"+c).html(g);SitemapView.register("sitemap-"+d.urid).initialize("sitemap-"+d.urid,E);a()});return true},onaction:function(b){var a="__api__/pages?user_locale=false&path_pageid="+E;B.getJSON(a,function(d){var c="";for(var e in d){c+=encodeURIComponent(d[e].title)+"/"}document.location=c.slice(0,-1).replace(/%20/g,"+")+"#editing"});B("#"+b).modal("hide")}})}function C(c,a){var b="__api__/pages/"+E+"/views/?_method=post&template="+c;if((a!==undefined)&&(a!=="")){b+="&parentid="+a}B.getJSON(b,function(d){location.reload()})}return{init:t,togglePageAdmins:G,showAddSubpage:H,showAddMainpage:s,showEditPage:y,showDeletePage:w,showEditView:x,showDeleteView:r,addSubview:C,showSitemap:F}})(jQuery);var TagListInput=(function(c){function d(f){f=((typeof f==="undefined")||(f===""))?".tag-list-wrapper":"#"+f;var e=c(f);e.each(function(){var l=c(this);if(l.children(".tag-list-ui").size()>0){return}var k=l.children("input");var g=k.hide().val().split(",");l.append("<div class='tag-list-ui'><input type='text' style='display: inline; border: 0' /></div>");var j=l.children(".tag-list-ui");var m=j.children("input");for(var h in g){b(k,m,g[h])}m.keypress(function(n){if((n.keyCode===13)||(n.keyCode===44)||(!m.is(":focus"))){var i=m.val();m.val("");b(k,m,i);k.val(k.val()+", "+i);return false}});m.keydown(function(o){var n=m.val();if((o.keyCode===8)&&(n==="")){var i=m.siblings().last();if(i.hasClass("selected")){i.children("div").click()}else{i.addClass("selected")}}else{m.siblings(".selected").removeClass("selected")}});m.focus(function(i){l.addClass("selected")});m.blur(function(i){m.trigger("keypress");l.removeClass("selected");j.children(".selected").removeClass("selected")});l.click(function(i){m.focus()})})}function b(h,i,e){e=e.trim();if(e===""){return}var f=c("<span></span>");f.addClass("tag-list-item").text(e).attr("data-tag",e);var g=c("<div style='cursor: pointer; padding-left: 3px;' aria-hidden='true'>&times;</div>");g.addClass("delete-btn");g.click(function(j){f.remove();a(h,i)});f.append(g);i.before(f)}function a(f,g){var e="";g.siblings().each(function(h){if(e!==""){e+=", "}e+=c(this).attr("data-tag")});f.val(e)}return{init:d}})(jQuery);var TagListInput=(function(h){function g(a){a=((typeof a==="undefined")||(a===""))?".tag-list-wrapper":"#"+a;var b=h(a);b.each(function(){var d=h(this);if(d.children(".tag-list-ui").size()>0){return}var i=d.children("input");var p=i.hide().val().split(",");d.append("<div class='tag-list-ui'><input type='text' style='display: inline; border: 0' /></div>");var n=d.children(".tag-list-ui");var c=n.children("input");for(var o in p){e(i,c,p[o])}c.keypress(function(k){if((k.keyCode===13)||(k.keyCode===44)||(!c.is(":focus"))){var j=c.val();c.val("");e(i,c,j);i.val(i.val()+", "+j);return false}});c.keydown(function(k){var l=c.val();if((k.keyCode===8)&&(l==="")){var j=c.siblings().last();if(j.hasClass("selected")){j.children("div").click()}else{j.addClass("selected")}}else{c.siblings(".selected").removeClass("selected")}});c.focus(function(j){d.addClass("selected")});c.blur(function(j){c.trigger("keypress");d.removeClass("selected");n.children(".selected").removeClass("selected")});d.click(function(j){c.focus()})})}function e(b,a,j){j=j.trim();if(j===""){return}var d=h("<span></span>");d.addClass("tag-list-item").text(j).attr("data-tag",j);var c=h("<div style='cursor: pointer; padding-left: 3px;' aria-hidden='true'>&times;</div>");c.addClass("delete-btn");c.click(function(i){d.remove();f(b,a)});d.append(c);a.before(d)}function f(b,a){var c="";a.siblings().each(function(d){if(c!==""){c+=", "}c+=h(this).attr("data-tag")});b.val(c)}return{init:g}})(jQuery);var TextEditor=(function(g){var d="";function p(r,q){k(r,q.replace(/^#/,""))}var n={bold:{icon:"fa-bold",method:function(r,q){return a("b",r,q)}},italic:{icon:"fa-italic",method:function(r,q){return a("i",r,q)}},"divider 1":"divider",ol:{icon:"fa-list-ol",method:function(r,q){return a("list",r,q,{addNewlines:true})}},ul:{icon:"fa-list-ul",method:function(r,q){return a("bullets",r,q,{addNewlines:true})}},"divider 2":"divider",email:{icon:"fa-envelope",method:function(r,q){return m(r,q)}},url:{icon:"fa-link",method:function(r,q){return c(r,q)}},video:{icon:"fa-film",method:function(r,q){return e(r,q)}},"divider 3":"divider",img:{icon:"fa-picture-o",method:function(r,q){return i(r,q)}},file:{icon:"fa-file",method:function(r,q){return h(r,q)}}};var l=n;function k(s,r){var q="<div class='texteditor_toolbar' data-selector='"+s+"' data-parent-modal='"+r+"' style='padding-bottom: 10px;'>";q+="<div class='btn-group'>";g.each(l,function(u,t){if(t==="divider"){q+="</div><div class='btn-group'>"}else{var v="<span class='fa "+t.icon+"'></span>";q+="<div class='btn btn-default' data-action='"+u+"'>"+v+"</div>"}});q+="</div></div>";g(q).insertBefore(s).find(".btn").on("click",function(){var t=g(this).attr("data-action");TextEditor.executeAction(s,t)});g(s).css("width","100%")}function b(r,q){d=g(".texteditor_toolbar",g(r).parent()).attr("data-parent-modal");l[q].method(o(r),function(s){f(r,s)})}function o(q){return g(q).textrange("get","text")}function f(q,r){g(q).textrange("replace",r)}function j(t,q,r,s){Modal.create({title:t,fade:false,oncreated:function(u){var w=g("#"+q).html();r=g.extend({},r,Locale.getViewsStrings(["system"]));r.urid=UIDGenerator.get();var v=Mustache.render(w,r);g(".modal-body","#"+u).html(v);g("#"+d).removeClass("fade").one("hidden.bs.modal",function(){g("#"+u).one("hidden.bs.modal",function(){g("#"+d).modal("show")}).modal("show")}).one("shown.bs.modal",function(){g("#"+d+", .modal-backdrop").addClass("fade")}).modal("hide")},onaction:function(u){var v={};g.each(g("form","#"+u).serializeArray(),function(w,x){v[x.name]=x.value});s(v);g("#"+u).modal("hide")}})}function a(q,t,s,r){if(r===undefined){r={}}if(r.addNewlines){t="\n"+t}t="["+q+"]"+t+"[/"+q+"]";if(r.addNewlines){t+="\n"}s(t)}function m(t,s){var r={};var q=Validator.isEmail({value:t});r.email=q?t:"";r.visible_text=q?"":t;j(Locale.str("system","texteditor_modal_email"),"template-texteditor-email",r,function(u){var v=(u.visible_text==="")?"[email]"+u.email+"[/email]":"[email="+u.email+"]"+u.visible_text+"[/email]";s(v)})}function c(t,s){var q={};var r=Validator.isUrl({value:t});q.url=r?t:"";q.visible_text=r?"":t;j(Locale.str("system","texteditor_modal_url"),"template-texteditor-url",q,function(u){var v=(u.visible_text==="")?"[url]"+u.url+"[/url]":"[url="+u.url+"]"+u.visible_text+"[/url]";s(v)})}function e(s,r){var q={};q.url=(Validator.isUrl({value:s}))?s:"";j(Locale.str("system","texteditor_modal_video"),"template-texteditor-video",q,function(t){r("[video]"+t.video+"[/video]")})}function i(r,q){Locale.ensureLoaded("files",{loaded:function(){var s="views/files/coworkers/select_file.mustache?static_only=true";g.get(s,{cache:true},function(u){var t=Mustache.to_html(u,Locale.getViewsStrings(["system","files"]));g("body").append("<div id='texteditor_selectfile'></div>");g("#texteditor_selectfile").html(t);SelectFile.show({multi:false,parentModalId:d,confirmed:function(v){q("[img]"+v.join()+"[/img]")},hidden:function(){g("#texteditor_selectfile").remove()}})})}})}function h(r,q){Locale.ensureLoaded("files",{loaded:function(){var s="views/files/coworkers/select_file.mustache?static_only=true";g.get(s,{cache:true},function(u){var t=Mustache.to_html(u,Locale.getViewsStrings(["system","files"]));g("body").append("<div id='texteditor_selectfile'></div>");g("#texteditor_selectfile").html(t);SelectFile.show({multi:false,parentModalId:d,confirmed:function(x){var v=x.join();var w=SelectFile.getCachedFilename(v);q("[url=__api__/files/"+v+"/download]"+w+"[/url]")},hidden:function(){g("#texteditor_selectfile").remove()}})})}})}return{init:p,executeAction:b}})(jQuery);var TextEditor=(function(z){var C="";function q(a,b){v(a,b.replace(/^#/,""))}var s={bold:{icon:"fa-bold",method:function(a,b){return F("b",a,b)}},italic:{icon:"fa-italic",method:function(a,b){return F("i",a,b)}},"divider 1":"divider",ol:{icon:"fa-list-ol",method:function(a,b){return F("list",a,b,{addNewlines:true})}},ul:{icon:"fa-list-ul",method:function(a,b){return F("bullets",a,b,{addNewlines:true})}},"divider 2":"divider",email:{icon:"fa-envelope",method:function(a,b){return t(a,b)}},url:{icon:"fa-link",method:function(a,b){return D(a,b)}},video:{icon:"fa-film",method:function(a,b){return B(a,b)}},"divider 3":"divider",img:{icon:"fa-picture-o",method:function(a,b){return x(a,b)}},file:{icon:"fa-file",method:function(a,b){return y(a,b)}}};var u=s;function v(a,b){var c="<div class='texteditor_toolbar' data-selector='"+a+"' data-parent-modal='"+b+"' style='padding-bottom: 10px;'>";c+="<div class='btn-group'>";z.each(u,function(e,f){if(f==="divider"){c+="</div><div class='btn-group'>"}else{var d="<span class='fa "+f.icon+"'></span>";c+="<div class='btn btn-default' data-action='"+e+"'>"+d+"</div>"}});c+="</div></div>";z(c).insertBefore(a).find(".btn").on("click",function(){var d=z(this).attr("data-action");TextEditor.executeAction(a,d)});z(a).css("width","100%")}function E(a,b){C=z(".texteditor_toolbar",z(a).parent()).attr("data-parent-modal");u[b].method(r(a),function(c){A(a,c)})}function r(a){return z(a).textrange("get","text")}function A(b,a){z(b).textrange("replace",a)}function w(a,d,c,b){Modal.create({title:a,fade:false,oncreated:function(g){var e=z("#"+d).html();c=z.extend({},c,Locale.getViewsStrings(["system"]));c.urid=UIDGenerator.get();var f=Mustache.render(e,c);z(".modal-body","#"+g).html(f);z("#"+C).removeClass("fade").one("hidden.bs.modal",function(){z("#"+g).one("hidden.bs.modal",function(){z("#"+C).modal("show")}).modal("show")}).one("shown.bs.modal",function(){z("#"+C+", .modal-backdrop").addClass("fade")}).modal("hide")},onaction:function(f){var e={};z.each(z("form","#"+f).serializeArray(),function(h,g){e[g.name]=g.value});b(e);z("#"+f).modal("hide")}})}function F(d,a,b,c){if(c===undefined){c={}}if(c.addNewlines){a="\n"+a}a="["+d+"]"+a+"[/"+d+"]";if(c.addNewlines){a+="\n"}b(a)}function t(a,b){var c={};var d=Validator.isEmail({value:a});c.email=d?a:"";c.visible_text=d?"":a;w(Locale.str("system","texteditor_modal_email"),"template-texteditor-email",c,function(f){var e=(f.visible_text==="")?"[email]"+f.email+"[/email]":"[email="+f.email+"]"+f.visible_text+"[/email]";b(e)})}function D(a,b){var d={};var c=Validator.isUrl({value:a});d.url=c?a:"";d.visible_text=c?"":a;w(Locale.str("system","texteditor_modal_url"),"template-texteditor-url",d,function(f){var e=(f.visible_text==="")?"[url]"+f.url+"[/url]":"[url="+f.url+"]"+f.visible_text+"[/url]";b(e)})}function B(a,b){var c={};c.url=(Validator.isUrl({value:a}))?a:"";w(Locale.str("system","texteditor_modal_video"),"template-texteditor-video",c,function(d){b("[video]"+d.video+"[/video]")})}function x(a,b){Locale.ensureLoaded("files",{loaded:function(){var c="views/files/coworkers/select_file.mustache?static_only=true";z.get(c,{cache:true},function(d){var e=Mustache.to_html(d,Locale.getViewsStrings(["system","files"]));z("body").append("<div id='texteditor_selectfile'></div>");z("#texteditor_selectfile").html(e);SelectFile.show({multi:false,parentModalId:C,confirmed:function(f){b("[img]"+f.join()+"[/img]")},hidden:function(){z("#texteditor_selectfile").remove()}})})}})}function y(a,b){Locale.ensureLoaded("files",{loaded:function(){var c="views/files/coworkers/select_file.mustache?static_only=true";z.get(c,{cache:true},function(d){var e=Mustache.to_html(d,Locale.getViewsStrings(["system","files"]));z("body").append("<div id='texteditor_selectfile'></div>");z("#texteditor_selectfile").html(e);SelectFile.show({multi:false,parentModalId:C,confirmed:function(f){var h=f.join();var g=SelectFile.getCachedFilename(h);b("[url=__api__/files/"+h+"/download]"+g+"[/url]")},hidden:function(){z("#texteditor_selectfile").remove()}})})}})}return{init:q,executeAction:E}})(jQuery);var UIDGenerator=(function(){function a(){var b=setTimeout(function(){clearTimeout(b)},0);return b}return{get:a}})();var Validator=(function(e){var j={};function k(n){j={};try{e("[data-validation]:visible",n).each(function(){c(this)})}catch(m){return false}return(Object.keys(j).length===0)}function c(o){var n=e(o).attr("data-validation").split(" ");var m=true;e.each(n,function(q,p){var r={};e(o).parent().removeClass("has-error");if(!b(p,o,r)){j[o.name]=(typeof j[o.name]!=="undefined")?j[o.name]:[];j[o.name].push(p);e(o).parent().addClass("has-error");m=false}});return m}function b(m,n,o){switch(m){case"required":return d(n,o);case"numeric":return a(n,o);case"email":return f(n,o);case"url":return l(n,o);case"date":return i(n,o);case"time":return h(n,o);case"datetime":return g(n,o);default:return true}}function d(m,n){return((m.nodeName==="INPUT")&&(m.type==="checkbox"))?m.checked:(m.value.replace(/\s+$/,"")!=="")}function a(n,o){var m=n.value;if(o.decimalChar!=="."){m=m.replace(o.decimalChar,".")}return !isNaN(m)}function f(n,o){var m=/^([a-zA-Z0-9_\.\-])+@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/;return m.test(n.value)}function l(n,o){var m=/^[-a-zA-Z0-9@:%_\+.~#?&//=]{2,256}\.[a-z]{2,4}\b(\/[-a-zA-Z0-9@:%_\+.~#?&//=]*)?$/gi;return m.test(n.value)}function i(n,o){var m=/^\d{4}-(((0?1|0?3|0?5|0?7|0?8|10|12)-(0?[1-9]|[12]?\d|3[01]))|((0?4|0?6|0?9|11)-(0?[1-9]|[12]?\d|30))|((0?2)-(0?[1-9]|[12]\d)))$/gi;return m.test(n.value)}function h(n,o){var m=/^([01]?[0-9]|2[0-3]):[0-5][0-9](:([0-5][0-9]))?$/gi;return m.test(n.value)}function g(n,o){var m=/^([\+-]?\d{4}(?!\d{2}\b))((-?)((0[1-9]|1[0-2])(\3([12]\d|0[1-9]|3[01]))?|W([0-4]\d|5[0-2])(-?[1-7])?|(00[1-9]|0[1-9]\d|[12]\d{2}|3([0-5]\d|6[1-6])))([T\s]((([01]\d|2[0-3])((:?)[0-5]\d)?|24\:?00)([\.,]\d+(?!:))?)?(\17[0-5]\d([\.,]\d+)?)?([zZ]|([\+-])([01]\d|2[0-3]):?([0-5]\d)?)?)?)?$/gi;return m.test(n.value)}return{validateForm:k,isRequired:d,isNumberic:a,isEmail:f,isUrl:l,isDate:i,isTime:h,isDateTime:g}})(jQuery);