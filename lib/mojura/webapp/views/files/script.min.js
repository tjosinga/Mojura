var FilesView=function(e){"use strict";var t=false;var i="root";var l="root";function o(e,t){if(i!==e){l=i;i=e;if(!t){n()}}}function r(){var t=e(".files-settings","#files_folders_container");var i=t.data();return i}function n(){var t=r();e("#files_folders_container").html("<div class='loading'></div>");var l=i;l=l!==""&&typeof l!=="undefined"?l:"root";var o="__api__/files/folder/"+l;e.getJSON(o,function(i){var l=e("#template_files_folders_container").html();e.extend(i,t);i.may_maintain=i.rights.allowed.update;i.is_root_folder=!i.id||i.id===t.root_folderid;window.console.log("Root folderid: "+t.root_folderid);i.has_other_root_folder=t.root_folderid!==undefined&&t.root_folderid!=="";i.has_subfolders=i.subfolders.length>0;i.has_files=i.files.length>0;for(var o=0;o<i.files.length;o++){i.files[o].is_image=typeof i.files[o].mime_type!=="undefined"&&i.files[o].mime_type!==null&&i.files[o].mime_type.slice(0,5)==="image";i.files[o].is_archive=typeof i.files[o].mime_type!=="undefined"&&i.files[o].mime_type!==null&&i.files[o].mime_type==="application/zip"}var r=Mustache.to_html(l,i);if(history.pushState){var n=window.location.toString();n=n.replace(/\?folderid=\w+/,"");if(i.id!==undefined&&i.id!==null){n+="?folderid="+i.id}history.pushState({},document.title,n)}e("#files_folders_container").html(r)})}function a(){d("post",i)}function s(e){d("put",e)}function d(t,i){var l=t==="post"?"action_add_file":"action_edit_file";Modal.create({title:Locale.str("files",l),id:"fileAddEditModal",oncreated:function(l,o){var r="__api__/files/";r+=t==="put"?i:"new";e("#"+l).modal("show");e.getJSON(r,function(r){var n=e("#template-files-add-edit-file").html();r=e.extend({},r,Locale.getViewsStrings(["system","files"]));if(t==="post"){r.folderid=i}r.method=t;r.urid=UIDGenerator.get();r.simple_rights_visible=(r.rights.rights&4)>0;var a={"rights-controls":e("#template-rights-controls").html()};var s=Mustache.render(n,r,a);e(".modal-body","#"+l).html(s);o()});return true},onsubmitted:function(e,t){n()}})}function f(t){Modal.create({title:Locale.str("files","action_delete_file"),btn_action:Locale.str("system","delete"),btn_class:"btn-danger",oncreated:function(i){var l=e("#template-files-delete-file").html();var o=Locale.getViewsStrings(["system","files"]);o.id=t;o.urid=UIDGenerator.get();var r=Mustache.render(l,o);e(".modal-body","#"+i).html(r)},onsubmitted:function(e,t){n()}})}function c(t){Modal.create({title:Locale.str("files","action_extract_file"),btn_action:Locale.str("files","action_extract"),oncreated:function(i){var l=e("#template-files-extract-file").html();var o=Locale.getViewsStrings(["system","files"]);o.id=t;o.urid=UIDGenerator.get();var r=Mustache.render(l,o);e(".modal-body","#"+i).html(r)},onsubmitted:function(e,t){n()}})}function _(){m("post",i)}function u(e){m("put",e)}function m(t,i){var l=t==="post"?"action_add_folder":"action_edit_folder";Modal.create({title:Locale.str("files",l),oncreated:function(l,o){var r="__api__/files/folder/";r+=t==="put"?i:"new";e("#"+l).modal("show");e.getJSON(r,function(r){var n=e("#template-files-add-edit-folder").html();r=e.extend({},r,Locale.getViewsStrings(["system","files"]));if(t==="post"){r.parentid=i;r.url="__api__/files/folders"}else{r.url="__api__/files/folder/"+i}r.method=t;r.urid=UIDGenerator.get();r.simple_rights_visible=(r.rights.right&4)>0;var a={"rights-controls":e("#template-rights-controls").html()};var s=Mustache.render(n,r,a);e(".modal-body","#"+l).html(s);o()});return true},onsubmitted:function(e,t){n()}})}function h(t){Modal.create({title:Locale.str("files","action_delete_folder"),btn_action:Locale.str("system","delete"),btn_class:"btn-danger",oncreated:function(i){var l=e("#template-files-delete-folder").html();var o=Locale.getViewsStrings(["system","files"]);o.id=t;o.urid=UIDGenerator.get();var r=Mustache.render(l,o);e(".modal-body","#"+i).html(r)},onsubmitted:function(e,t){n()}})}return{setCurrentFolderId:o,refresh:n,addFile:a,editFile:s,deleteFile:f,extractFile:c,addFolder:_,editFolder:u,deleteFolder:h}}(jQuery);