var FilesView=(function(f){var k=false;var n="root";var o="root";function i(r,q){if(n!==r){o=n;n=r;if(!q){j()}}}function m(){var q=f(".files-settings","#files_folders_container");var r=q.data();return r}function j(){var r=m();f("#files_folders_container").html("<div class='loading'></div>");var s=n;s=((s!=="")&&(typeof s!=="undefined"))?s:"root";var q="__api__/files/folder/"+s;f.getJSON(q,function(w){var v=f("#template_files_folders_container").html();f.extend(w,r);w.may_maintain=(w.rights.allowed.update);w.is_root_folder=(!w.id)||(w.id===r.root_folderid);window.console.log("Root folderid: "+r.root_folderid);w.has_other_root_folder=(r.root_folderid!==undefined)&&(r.root_folderid!=="");w.has_subfolders=(w.subfolders.length>0);w.has_files=(w.files.length>0);for(var u=0;u<w.files.length;u++){w.files[u].is_image=(typeof w.files[u].mime_type!=="undefined")&&(w.files[u].mime_type!==null)&&(w.files[u].mime_type.slice(0,5)==="image");w.files[u].is_archive=(typeof w.files[u].mime_type!=="undefined")&&(w.files[u].mime_type!==null)&&(w.files[u].mime_type==="application/zip")}var t=Mustache.to_html(v,w);if(history.pushState){var x=window.location.toString();x=x.replace(/\?folderid=\w+/,"");if((w.id!==undefined)&&(w.id!==null)){x+="?folderid="+w.id}history.pushState({},document.title,x)}f("#files_folders_container").html(t)})}function c(){h("post",n)}function l(q){h("put",q)}function h(s,r){var q=(s==="post")?"action_add_file":"action_edit_file";Modal.create({title:Locale.str("files",q),id:"fileAddEditModal",oncreated:function(t,v){var u="__api__/files/";u+=(s==="put")?r:"new";f("#"+t).modal("show");f.getJSON(u,function(z){var y=f("#template-files-add-edit-file").html();z=f.extend({},z,Locale.getViewsStrings(["system","files"]));if(s==="post"){z.folderid=r}z.method=s;z.urid=UIDGenerator.get();z.simple_rights_visible=((z.rights.rights&4)>0);var x={"rights-controls":f("#template-rights-controls").html()};var w=Mustache.render(y,z,x);f(".modal-body","#"+t).html(w);v()});return true},onsubmitted:function(t,u){j()}})}function g(q){Modal.create({title:Locale.str("files","action_delete_file"),btn_action:Locale.str("system","delete"),btn_class:"btn-danger",oncreated:function(r){var t=f("#template-files-delete-file").html();var u=Locale.getViewsStrings(["system","files"]);u.id=q;u.urid=UIDGenerator.get();var s=Mustache.render(t,u);f(".modal-body","#"+r).html(s)},onsubmitted:function(r,s){j()}})}function p(q){Modal.create({title:Locale.str("files","action_extract_file"),btn_action:Locale.str("files","action_extract"),oncreated:function(r){var t=f("#template-files-extract-file").html();var u=Locale.getViewsStrings(["system","files"]);u.id=q;u.urid=UIDGenerator.get();var s=Mustache.render(t,u);f(".modal-body","#"+r).html(s)},onsubmitted:function(r,s){j()}})}function e(){b("post",n)}function a(q){b("put",q)}function b(s,r){var q=(s==="post")?"action_add_folder":"action_edit_folder";Modal.create({title:Locale.str("files",q),oncreated:function(t,v){var u="__api__/files/folder/";u+=(s==="put")?r:"new";f("#"+t).modal("show");f.getJSON(u,function(z){var y=f("#template-files-add-edit-folder").html();z=f.extend({},z,Locale.getViewsStrings(["system","files"]));if(s==="post"){z.parentid=r;z.url="__api__/files/folders"}else{z.url="__api__/files/folder/"+r}z.method=s;z.urid=UIDGenerator.get();z.simple_rights_visible=((z.rights.right&4)>0);var x={"rights-controls":f("#template-rights-controls").html()};var w=Mustache.render(y,z,x);f(".modal-body","#"+t).html(w);v()});return true},onsubmitted:function(t,u){j()}})}function d(q){Modal.create({title:Locale.str("files","action_delete_folder"),btn_action:Locale.str("system","delete"),btn_class:"btn-danger",oncreated:function(r){var t=f("#template-files-delete-folder").html();var u=Locale.getViewsStrings(["system","files"]);u.id=q;u.urid=UIDGenerator.get();var s=Mustache.render(t,u);f(".modal-body","#"+r).html(s)},onsubmitted:function(r,s){j()}})}return{setCurrentFolderId:i,refresh:j,addFile:c,editFile:l,deleteFile:g,extractFile:p,addFolder:e,editFolder:a,deleteFolder:d}})(jQuery);