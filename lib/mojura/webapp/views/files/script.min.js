var FilesView=function(e){"use strict";var t=false;var i="root";var l="root";function r(e,t){if(i!==e){l=i;i=e;if(!t){a()}}}function o(){var t=e(".files-settings","#files_folders_container");var i=t.data();return i}function a(){var t=o();e("#files_folders_container").html("<div class='loading'></div>");var l=i;l=l!==""&&typeof l!=="undefined"?l:"root";var r="__api__/files/folder/"+l;e.getJSON(r,function(i){var l=e("#template_files_folders_container").html();e.extend(i,t);i.may_maintain=i.rights.allowed.update;i.is_base_folder=!i.id||i.id===t.base_folderid;i.has_subfolders=i.subfolders.length>0;i.has_files=i.files.length>0;for(var r=0;r<i.files.length;r++){i.files[r].is_image=typeof i.files[r].mime_type!=="undefined"&&i.files[r].mime_type!=null&&i.files[r].mime_type.slice(0,5)==="image";i.files[r].is_archive=typeof i.files[r].mime_type!=="undefined"&&i.files[r].mime_type!=null&&i.files[r].mime_type==="application/zip"}var o=Mustache.to_html(l,i);if(history.pushState){var a=window.location.toString();a=a.replace(/\?folderid=\w+/,"");if(i.id!==undefined&&i.id!==null){a+="?folderid="+i.id}history.pushState({},document.title,a)}e("#files_folders_container").html(o)})}function n(){d("post",i)}function s(e){d("put",e)}function d(t,i){var l=t==="post"?"action_add_file":"action_edit_file";Modal.create({title:Locale.str("files",l),oncreated:function(l,r){var o="__api__/files/";o+=t==="put"?i:"new";e("#"+l).modal("show");e.getJSON(o,function(o){var a=e("#template-files-add-edit-file").html();o=e.extend({},o,Locale.getViewsStrings(["system","files"]));if(t==="post"){o.folderid=i}o.method=t;o.urid=UIDGenerator.get();o.simple_rights_visible=(o.rights.rights&4)>0;var n={"rights-controls":e("#template-rights-controls").html()};var s=Mustache.render(a,o,n);e(".modal-body","#"+l).html(s);r()});return true},onsubmitted:function(e,t){a()}})}function f(t){Modal.create({title:Locale.str("files","action_delete_file"),btn_action:Locale.str("system","delete"),btn_class:"btn-danger",oncreated:function(i){var l=e("#template-files-delete-file").html();var r=Locale.getViewsStrings(["system","files"]);r.id=t;r.urid=UIDGenerator.get();var o=Mustache.render(l,r);e(".modal-body","#"+i).html(o)},onsubmitted:function(e,t){a()}})}function c(t){Modal.create({title:Locale.str("files","action_extract_file"),btn_action:Locale.str("files","action_extract"),oncreated:function(i){var l=e("#template-files-extract-file").html();var r=Locale.getViewsStrings(["system","files"]);r.id=t;r.urid=UIDGenerator.get();var o=Mustache.render(l,r);e(".modal-body","#"+i).html(o)},onsubmitted:function(e,t){a()}})}function u(){m("post",i)}function _(e){m("put",e)}function m(t,i){var l=t==="post"?"action_add_folder":"action_edit_folder";Modal.create({title:Locale.str("files",l),oncreated:function(l,r){var o="__api__/files/folder/";o+=t==="put"?i:"new";e("#"+l).modal("show");e.getJSON(o,function(o){var a=e("#template-files-add-edit-folder").html();o=e.extend({},o,Locale.getViewsStrings(["system","files"]));if(t==="post"){o.parentid=i;o.url="__api__/files/folders"}else{o.url="__api__/files/folder/"+i}o.method=t;o.urid=UIDGenerator.get();o.simple_rights_visible=(o.rights.right&4)>0;var n={"rights-controls":e("#template-rights-controls").html()};var s=Mustache.render(a,o,n);e(".modal-body","#"+l).html(s);r()});return true},onsubmitted:function(e,t){a()}})}function h(t){Modal.create({title:Locale.str("files","action_delete_folder"),btn_action:Locale.str("system","delete"),btn_class:"btn-danger",oncreated:function(i){var l=e("#template-files-delete-folder").html();var r=Locale.getViewsStrings(["system","files"]);r.id=t;r.urid=UIDGenerator.get();var o=Mustache.render(l,r);e(".modal-body","#"+i).html(o)},onsubmitted:function(e,t){a()}})}return{setCurrentFolderId:r,refresh:a,addFile:n,editFile:s,deleteFile:f,extractFile:c,addFolder:u,editFolder:_,deleteFolder:h}}(jQuery);