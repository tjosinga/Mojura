var UsersView=function(a){"use strict";var t="";function e(a){t=a}function r(){var e={};Modal.create({title:Locale.str("users","edit_userinfo"),oncreated:function(r,s){a("#"+r).modal("show");a.getJSON("__api__/users/"+t,function(t){e=t;var o=a("#template-edit-userinfo").html();var n=Mustache.render(o,t);a(".modal-body","#"+r).html(n);s()});return true},onsubmitted:function(r,s){if(e.fullname!==s.fullname){a(".fullname","#user-info-"+t).text(s.fullname)}if(e.email!==s.email){a(".email a","#user-info-"+t).text(s.email).attr("href","mailto:"+s.email)}if(e.avatar!==s.avatar){var o=a(".avatar img","#user-info-"+t).attr("src");o=o.replace(e.avatar,s.avatar);a(".avatar img","#user-info-"+t).attr("src",o)}}})}function s(){Modal.create({title:Locale.str("users","edit_avatar"),btn_action:Locale.str("system","close"),btn_cancel:false,save_form:false,oncreated:function(e,r){a("#"+e).modal("show");a.getJSON("__api__/users/"+t+"?include_settings=core.realm",function(t){var s=a("#template-edit-avatar").html();if(t.avatar.indexOf("gravatar.com")>0){t.gravatar=t.avatar+"&s=256";t.avatar=t.gravatar+"&f=y";t.uses_gravatar=true}else{t.gravatar="http://www.gravatar.com/avatar/"+CryptoJS.MD5(t.email)+"?d=mm&s=256";t.uses_gravatar=false}var o=Mustache.render(s,t);a(".modal-body","#"+e).html(o);r()});return true}})}function o(t){t.ajaxForm({success:function(t){var e=t[0];a(".avatar",".avatar-form").parent().addClass("selected").find("img").attr("src",e);a(".gravatar",".avatar-form").parent().removeClass("selected");a(".btn-delete",".avatar-form").removeClass("hidden");a(".view-data .user-info .avatar img").attr("src",e);a("form",".avatar-form").reset()},error:function(){window.alert("failed")}}).submit()}function n(){var e="__api__/users/"+t+"/avatar?_method=delete";a.getJSON(e,function(t){var e=t[0]+"&s=256";a(".avatar",".avatar-form").parent().removeClass("selected").find("img").attr("src",e+"&f=y");a(".gravatar",".avatar-form").parent().addClass("selected");a(".btn-delete",".avatar-form").addClass("hidden");a(".view-data .user-info .avatar img").attr("src",e)}).error(function(){window.alert("failed")})}function i(){Modal.create({title:Locale.str("users","edit_password"),save_form:false,oncreated:function(e,r){a("#"+e).modal("show");a.getJSON("__api__/users/"+t+"?include_settings=core.realm",function(t){var s=a("#template-edit-password").html();t.force_password=t.force_password===true;var o=Mustache.render(s,t);a(".modal-body","#"+e).html(o);r()});return true},onaction:function(t){var e=a("form","#"+t);a("input[type=password]").removeClass("has-error");var r=e.attr("data-username");var s=e.attr("data-realm");var o=a("input[name=password_old]",e).val();var n=a("input[name=password_new]",e).val();var i=a("input[name=password_check]",e).val();if(n!==i){a("input[name=password_new], input[name=password_check]").closest(".form-group").addClass("has-error");return}var d="new_password="+CryptoJS.MD5(r+":"+s+":"+n).toString();if(o!==undefined){d+="&old_password="+CryptoJS.MD5(r+":"+s+":"+o).toString()}d+="&_method=put";a.post(e.attr("action"),d,function(){a(".btn-primary","#"+t).button("complete").addClass("btn-success disabled");a("#"+t).modal("hide")}).fail(function(){window.alert("an error occured")})}})}function d(){Modal.create({title:Locale.str("users","edit_groups"),oncreated:function(t){var e=a("#template-edit-groups").html();var r={};var s=Mustache.render(e,r);a(".modal-body","#"+t).html(s)},onsubmitted:function(a){}})}function l(){Modal.create({title:Locale.str("users","deactivate_user"),oncreated:function(t){var e=a("#template-deactivate-user").html();var r={};var s=Mustache.render(e,r);a(".modal-body","#"+t).html(s)},onsubmitted:function(a){}})}return{initialize:e,showEditUserInfo:r,showEditAvatar:s,uploadAvatar:o,deleteAvatar:n,showEditPassword:i,showEditGroups:d,showDeactivateUser:l}}(jQuery);