var UsersView=(function(e){var a="";function f(k){a=k}function i(){var k={};Modal.create({title:Locale.str("users","edit_userinfo"),oncreated:function(l,m){e("#"+l).modal("show");e.getJSON("__api__/users/"+a,function(o){k=o;var p=e("#template-edit-userinfo").html();var n=Mustache.render(p,o);e(".modal-body","#"+l).html(n);m()});return true},onsubmitted:function(l,m){if(k.fullname!==m.fullname){e(".fullname","#user-info-"+a).text(m.fullname)}if(k.email!==m.email){e(".email a","#user-info-"+a).text(m.email).attr("href","mailto:"+m.email)}if(k.avatar!==m.avatar){var n=e(".avatar img","#user-info-"+a).attr("src");n=n.replace(k.avatar,m.avatar);e(".avatar img","#user-info-"+a).attr("src",n)}}})}function g(){Modal.create({title:Locale.str("users","edit_avatar"),btn_action:Locale.str("system","close"),btn_cancel:false,save_form:false,oncreated:function(k,l){e("#"+k).modal("show");e.getJSON("__api__/users/"+a+"?include_settings=core.realm",function(n){var o=e("#template-edit-avatar").html();if(n.avatar.indexOf("gravatar.com")>0){n.gravatar=n.avatar+"&s=256";n.avatar=n.gravatar+"&f=y";n.uses_gravatar=true}else{n.gravatar="http://www.gravatar.com/avatar/"+CryptoJS.MD5(n.email)+"?d=mm&s=256";n.uses_gravatar=false}var m=Mustache.render(o,n);e(".modal-body","#"+k).html(m);l()});return true}})}function c(k){k.ajaxForm({success:function(l){var m=l[0];e(".avatar",".avatar-form").parent().addClass("selected").find("img").attr("src",m);e(".gravatar",".avatar-form").parent().removeClass("selected");e(".btn-delete",".avatar-form").removeClass("hidden");e(".view-data .user-info .avatar img").attr("src",m);e("form",".avatar-form").reset()},error:function(){window.alert("failed")}}).submit()}function j(){var k="__api__/users/"+a+"/avatar?_method=delete";e.getJSON(k,function(l){var m=l[0]+"&s=256";e(".avatar",".avatar-form").parent().removeClass("selected").find("img").attr("src",m+"&f=y");e(".gravatar",".avatar-form").parent().addClass("selected");e(".btn-delete",".avatar-form").addClass("hidden");e(".view-data .user-info .avatar img").attr("src",m)}).error(function(){window.alert("failed")})}function h(){Modal.create({title:Locale.str("users","edit_password"),save_form:false,oncreated:function(k,l){e("#"+k).modal("show");e.getJSON("__api__/users/"+a+"?include_settings=core.realm",function(n){var o=e("#template-edit-password").html();n.force_password=(n.force_password===true);var m=Mustache.render(o,n);e(".modal-body","#"+k).html(m);l()});return true},onaction:function(m){var n=e("form","#"+m);e("input[type=password]").removeClass("has-error");var r=n.attr("data-username");var l=n.attr("data-realm");var k=e("input[name=password_old]",n).val();var q=e("input[name=password_new]",n).val();var p=e("input[name=password_check]",n).val();if(q!==p){e("input[name=password_new], input[name=password_check]").closest(".form-group").addClass("has-error");return}var o="new_password="+CryptoJS.MD5(r+":"+l+":"+q).toString();if(k!==undefined){o+="&old_password="+CryptoJS.MD5(r+":"+l+":"+k).toString()}o+="&_method=put";e.post(n.attr("action"),o,function(){e(".btn-primary","#"+m).button("complete").addClass("btn-success disabled");e("#"+m).modal("hide")}).fail(function(){window.alert("an error occured")})}})}function b(){Modal.create({title:Locale.str("users","edit_groups"),oncreated:function(k){var m=e("#template-edit-groups").html();var n={};var l=Mustache.render(m,n);e(".modal-body","#"+k).html(l)},onsubmitted:function(k){}})}function d(){Modal.create({title:Locale.str("users","deactivate_user"),oncreated:function(k){var m=e("#template-deactivate-user").html();var n={};var l=Mustache.render(m,n);e(".modal-body","#"+k).html(l)},onsubmitted:function(k){}})}return{initialize:f,showEditUserInfo:i,showEditAvatar:g,uploadAvatar:c,deleteAvatar:j,showEditPassword:h,showEditGroups:b,showDeactivateUser:d}})(jQuery);