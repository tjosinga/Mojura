var MapsView=function($){"use strict";var maps={};function initMap(t,a){a.initLat=a.initLat||0;a.initLng=a.initLng||0;a.initZoom=a.initZoom||0;a.category=a.category||"";a.showAdmin=a.showAdmin===true;maps[t]=a;maps[t].markers=[];maps[t].map=L.map(t).setView([a.initLat,a.initLng],a.initZoom);a.tileUrl=a.tileUrl||"http://{s}.tile.osm.org/{z}/{x}/{y}.png";a.tileAttribution=a.tileAttribution||'&copy; <a href="http://osm.org/copyright">OpenStreetMap</a>';L.tileLayer(a.tileUrl,{attribution:a.tileAttribution}).addTo(maps[t].map);if(a.showAdmin){maps[t].map.on("click",onMapClick)}}function onMapClick(t){if(t.originalEvent.altKey){var a=$(t.originalEvent.target).parents(".leaflet-map").attr("id");addEditLocation(a,"new",t.latlng)}}function loadLocations(mapId,zoomFactor){while(maps[mapId].markers.length>0){var marker=maps[mapId].markers.pop();maps[mapId].map.removeLayer(marker)}var url="__api__/locations";if(maps[mapId].category!==""){url+="?category="+encodeURIComponent(category)}$.getJSON(url,function(locations){if(typeof locations!=="undefined"){for(var i in locations){addMarker(mapId,locations[i])}zoomFactor>=0?centerOnMarkers(mapId,zoomFactor):autoZoom(mapId);$(".leaflet-popup-pane script","#"+mapId).each(function(index){eval($(this).text())})}})}function addMarker(t,a){if(maps[t]===undefined){window.console.log("MapsView.addLocation: Unknown mapId");return}var o=L.marker([a.latitude,a.longitude],{draggable:maps[t].showAdmin}).addTo(maps[t].map);var e="<h5>"+a.title+"</h5>"+a.description.html;if(maps[t].showAdmin){var n="<div class='btn-group btn-group-xs'>";n+="<button type='button' class='btn btn-default' onclick='MapsView.editLocation(\""+t+'", "'+a.id+"\")'><i class='fa fa-pencil'></i></button>";n+="<button type='button' class='btn btn-default' onclick='MapsView.deleteLocation(\""+t+'", "'+a.id+"\")'><i class='fa fa-trash-o'></i></button>";n+="</div>";e=n+e}o.bindPopup(e);o.on("dragend",function(t){var e=o.getLatLng();var n="__api__/locations/"+a.id+"?_method=put&";n+="address="+e.lat+","+e.lng;o.setOpacity(.5);$.getJSON(n,function(t){o.setOpacity(1)})});maps[t].markers.push(o)}function autoZoom(t){if(maps[t]===undefined){window.console.log("MapsView.addLocation: Unknown mapId");return}var a=new L.featureGroup(maps[t].markers);maps[t].map.fitBounds(a.getBounds().pad(.2))}function centerOnMarkers(t,a){if(maps[t]===undefined){window.console.log("MapsView.addLocation: Unknown mapId");return}var o=new L.featureGroup(maps[t].markers);maps[t].map.setZoom(a);maps[t].map.panTo(o.getBounds().getCenter())}function addLocation(t){addEditLocation(t,"new")}function editLocation(t,a){addEditLocation(t,a)}function addEditLocation(t,a,o){Modal.create({id:"mapsAddEditModal",modal_large:true,title:Locale.str("maps",a==="new"?"add":"edit"),oncreated:function(e,n){$("#"+e).modal("show");var i="__api__/locations/"+a;$.getJSON(i,function(i){var d=$("#template-maps-addedit").html();i=$.extend({},i,Locale.getViewsStrings(["system","maps"]));i.method=a==="new"?"post":"put";if(a==="new"){i.category=maps[t].category;if(typeof o!=="undefined"){i.latitude=o.lat;i.longitude=o.lng}}i.locationid=a;i.urid=UIDGenerator.get();var r=Mustache.render(d,i);$(".modal-body","#"+e).html(r);n()});return true},onerror:function(t,a){if(a==412){$(".alert-address-not-found").removeClass("hidden")}},onsubmitted:function(a,o){loadLocations(t,-1)}})}function deleteLocation(t,a){Modal.create({id:"mapsDeleteModal",btn_class:"btn-danger",btn_action:Locale.str("system","delete"),title:Locale.str("maps","delete"),oncreated:function(t){$("#"+t).modal("show");var o=$("#template-maps-delete").html();var e=Locale.getViewsStrings(["system","maps"]);e.locationid=a;e.urid=UIDGenerator.get();var n=Mustache.render(o,e);$(".modal-body","#"+t).html(n)},onsubmitted:function(a,o){loadLocations(t,maps[t].map.getZoom())}})}return{initMap:initMap,loadLocations:loadLocations,addMarker:addMarker,addLocation:addLocation,editLocation:editLocation,deleteLocation:deleteLocation}}(jQuery);